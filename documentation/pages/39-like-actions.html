<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Like/Pass Actions - GreenGo Documentation</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">ğŸŒ¿</span>
                <a href="../index.html" class="logo-text" style="text-decoration: none; color: #D4AF37;">GreenGo</a>
            </div>
        </div>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search...">
        </div>
        <ul class="nav-menu" id="navMenu">
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-home"></i><span>Overview</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="01-introduction.html">1. Introduction</a></li>
                    <li><a href="02-tech-stack.html">2. Tech Stack</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-sitemap"></i><span>Architecture</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="09-clean-architecture.html">9. Clean Architecture</a></li>
                    <li><a href="14-data-flow.html">14. Data Flow</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-palette"></i><span>Design System</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="21-brand-guidelines.html">21. Brand</a></li>
                    <li><a href="22-color-palette.html">22. Colors</a></li>
                    <li><a href="25-components.html">25. Components</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-puzzle-piece"></i><span>Core Features</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="31-auth-flow.html">31. Auth Flow</a></li>
                    <li><a href="32-social-auth.html">32. Social Auth</a></li>
                    <li><a href="33-biometric-auth.html">33. Biometric</a></li>
                    <li><a href="34-onboarding.html">34. Onboarding</a></li>
                    <li><a href="35-photo-upload.html">35. Photos</a></li>
                    <li><a href="36-profile-editing.html">36. Profile</a></li>
                    <li><a href="37-matching-algorithm.html">37. Matching</a></li>
                    <li><a href="38-discovery.html">38. Discovery</a></li>
                    <li><a href="39-like-actions.html">39. Actions</a></li>
                    <li><a href="40-match-system.html">40. Matches</a></li>
                    <li><a href="41-chat.html">41. Chat</a></li>
                    <li><a href="42-message-features.html">42. Messages</a></li>
                    <li><a href="43-push-notifications.html">43. Push</a></li>
                    <li><a href="44-in-app-notifications.html">44. Notifications</a></li>
                    <li><a href="45-subscriptions.html">45. Subscriptions</a></li>
                    <li><a href="46-in-app-purchases.html">46. Purchases</a></li>
                    <li><a href="47-coins.html">47. Coins</a></li>
                    <li><a href="48-gamification.html">48. Gamification</a></li>
                    <li><a href="49-challenges.html">49. Challenges</a></li>
                    <li><a href="50-leaderboards.html">50. Leaderboards</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-server"></i><span>Backend</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="51-firebase-overview.html">51. Firebase</a></li>
                    <li><a href="55-cloud-functions.html">55. Functions</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-database"></i><span>Database</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="61-firestore-schema.html">61. Schema</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-shield-alt"></i><span>Security</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="69-security-architecture.html">69. Security</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="top-header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            <div class="header-title"><h1>Like/Pass Actions</h1></div>
        </header>

        <div class="content-wrapper">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a> / <a href="#">Core Features</a> / Like/Pass Actions
                </div>
            </div>

            <div class="page-content">
                
            <h2>Swipe Actions System</h2>
            <p>Complete implementation of Like, Pass, Super Like, and Rewind actions with rate limiting and subscription checks.</p>

            <h2>Action Types</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ACTION TYPES                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      LIKE       â”‚  â”‚      PASS       â”‚  â”‚   SUPER LIKE    â”‚  â”‚     REWIND      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Direction:Right â”‚  â”‚ Direction:Left  â”‚  â”‚ Direction: Up   â”‚  â”‚ Undo last swipe â”‚
â”‚ Creates swipe   â”‚  â”‚ Creates swipe   â”‚  â”‚ Creates swipe   â”‚  â”‚ Removes swipe   â”‚
â”‚ Checks match    â”‚  â”‚ No match check  â”‚  â”‚ Notifies user   â”‚  â”‚ Returns card    â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚ Priority queue  â”‚  â”‚                 â”‚
â”‚ Limits:         â”‚  â”‚ Limits:         â”‚  â”‚ Limits:         â”‚  â”‚ Limits:         â”‚
â”‚ Basic: 100/day  â”‚  â”‚ Unlimited       â”‚  â”‚ Basic: 1/day    â”‚  â”‚ Gold only       â”‚
â”‚ Silver: Unlim   â”‚  â”‚                 â”‚  â”‚ Silver: 5/day   â”‚  â”‚ 1 per swipe     â”‚
â”‚ Gold: Unlimited â”‚  â”‚                 â”‚  â”‚ Gold: 5/day     â”‚  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </code></pre>

            <h2>Swipe Recording Flow</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SWIPE RECORDING SEQUENCE                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client            BLoC              UseCase          Repository        Function
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚ Swipe Right    â”‚                   â”‚                 â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚ Check limits      â”‚                 â”‚                â”‚
  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                 â”‚                â”‚
  â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚ RecordSwipe       â”‚                 â”‚                â”‚
  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚ recordSwipe()   â”‚                â”‚
  â”‚                â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚ Callable       â”‚
  â”‚                â”‚                   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚ 1. Create doc  â”‚
  â”‚                â”‚                   â”‚                 â”‚ 2. Check match â”‚
  â”‚                â”‚                   â”‚                 â”‚ 3. Update statsâ”‚
  â”‚                â”‚                   â”‚                 â”‚ 4. Award XP    â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚   SwipeResult   â”‚                â”‚
  â”‚                â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚ SwipeSuccess      â”‚                 â”‚                â”‚
  â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚ Update UI      â”‚                   â”‚                 â”‚                â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
  â”‚ If matched:    â”‚                   â”‚                 â”‚                â”‚
  â”‚ Show animation â”‚                   â”‚                 â”‚                â”‚
  â”‚                â”‚                   â”‚                 â”‚                â”‚
            </code></pre>

            <h2>Cloud Function Implementation</h2>
            <pre><code class="language-typescript">
// functions/src/matching/recordSwipe.ts

interface SwipeParams {
  swipedId: string;
  type: 'like' | 'superlike' | 'pass';
}

interface SwipeResult {
  success: boolean;
  matched: boolean;
  matchId?: string;
  conversationId?: string;
  error?: string;
}

export const recordSwipe = functions
  .runWith({ memory: '256MB', timeoutSeconds: 30 })
  .https.onCall(async (data: SwipeParams, context): Promise<SwipeResult> => {
    // 1. Authentication check
    if (!context.auth) {
      throw new functions.https.HttpsError('unauthenticated', 'Must be logged in');
    }

    const swiperId = context.auth.uid;
    const { swipedId, type } = data;

    // 2. Validate not swiping self
    if (swiperId === swipedId) {
      throw new functions.https.HttpsError('invalid-argument', 'Cannot swipe yourself');
    }

    // 3. Check for existing swipe
    const existingSwipe = await firestore
      .collection('swipes')
      .doc(`${swiperId}_${swipedId}`)
      .get();

    if (existingSwipe.exists) {
      return { success: false, matched: false, error: 'Already swiped' };
    }

    // 4. Get user data for limit checks
    const userDoc = await firestore.collection('users').doc(swiperId).get();
    const user = userDoc.data()!;

    // 5. Check daily limits
    if (type === 'like') {
      const likesResult = await checkDailyLikes(swiperId, user.subscription.tier);
      if (!likesResult.allowed) {
        return { success: false, matched: false, error: 'Daily like limit reached' };
      }
    } else if (type === 'superlike') {
      const superLikesResult = await checkSuperLikes(swiperId, user.subscription.tier);
      if (!superLikesResult.allowed) {
        return { success: false, matched: false, error: 'No super likes remaining' };
      }
    }

    // 6. Create swipe document
    const swipeRef = firestore.collection('swipes').doc(`${swiperId}_${swipedId}`);
    const swipeData = {
      id: swipeRef.id,
      swiperId,
      swipedId,
      type,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      matchCreated: false,
      source: 'discovery',
    };

    // 7. Check for mutual like (match)
    let matched = false;
    let matchId: string | undefined;
    let conversationId: string | undefined;

    if (type === 'like' || type === 'superlike') {
      const reverseSwipe = await firestore
        .collection('swipes')
        .doc(`${swipedId}_${swiperId}`)
        .get();

      if (reverseSwipe.exists) {
        const reverseData = reverseSwipe.data()!;
        if (reverseData.type === 'like' || reverseData.type === 'superlike') {
          // MATCH!
          matched = true;
          const matchResult = await createMatch(swiperId, swipedId);
          matchId = matchResult.matchId;
          conversationId = matchResult.conversationId;
          swipeData.matchCreated = true;
        }
      }
    }

    // 8. Write swipe and update stats in batch
    const batch = firestore.batch();

    batch.set(swipeRef, swipeData);

    // Update swiper stats
    batch.update(firestore.collection('users').doc(swiperId), {
      'stats.totalSwipes': admin.firestore.FieldValue.increment(1),
      ...(type !== 'pass' && {
        'stats.totalLikes': admin.firestore.FieldValue.increment(1),
      }),
      ...(type === 'superlike' && {
        'stats.superLikesUsed': admin.firestore.FieldValue.increment(1),
      }),
      ...(matched && {
        'stats.totalMatches': admin.firestore.FieldValue.increment(1),
      }),
    });

    // Award XP
    const xpAmount = type === 'superlike' ? 10 : type === 'like' ? 5 : 1;
    batch.update(firestore.collection('users').doc(swiperId), {
      xp: admin.firestore.FieldValue.increment(xpAmount),
    });

    await batch.commit();

    // 9. Send notifications if super like or match
    if (type === 'superlike' && !matched) {
      await sendSuperLikeNotification(swipedId, swiperId);
    }

    return {
      success: true,
      matched,
      matchId,
      conversationId,
    };
  });

async function createMatch(user1: string, user2: string) {
  const matchRef = firestore.collection('matches').doc();
  const conversationRef = firestore.collection('conversations').doc();

  // Get user profiles for match document
  const [user1Doc, user2Doc] = await Promise.all([
    firestore.collection('users').doc(user1).get(),
    firestore.collection('users').doc(user2).get(),
  ]);

  const user1Data = user1Doc.data()!;
  const user2Data = user2Doc.data()!;

  const batch = firestore.batch();

  // Create match document
  batch.set(matchRef, {
    id: matchRef.id,
    users: [user1, user2],
    userProfiles: {
      [user1]: {
        name: user1Data.name,
        photo: user1Data.photos[0]?.url,
        age: calculateAge(user1Data.birthDate),
      },
      [user2]: {
        name: user2Data.name,
        photo: user2Data.photos[0]?.url,
        age: calculateAge(user2Data.birthDate),
      },
    },
    conversationId: conversationRef.id,
    matchedAt: admin.firestore.FieldValue.serverTimestamp(),
    compatibilityScore: await calculateCompatibility(user1, user2),
    status: 'active',
  });

  // Create conversation document
  batch.set(conversationRef, {
    id: conversationRef.id,
    matchId: matchRef.id,
    participants: [user1, user2],
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    lastMessageAt: admin.firestore.FieldValue.serverTimestamp(),
    lastMessage: null,
    unreadCount: { [user1]: 0, [user2]: 0 },
    isActive: true,
  });

  await batch.commit();

  // Send match notifications to both users
  await Promise.all([
    sendMatchNotification(user1, user2Data.name, matchRef.id),
    sendMatchNotification(user2, user1Data.name, matchRef.id),
  ]);

  return {
    matchId: matchRef.id,
    conversationId: conversationRef.id,
  };
}
            </code></pre>

            <h2>Rate Limiting</h2>
            <table>
                <thead>
                    <tr><th>Action</th><th>Basic</th><th>Silver</th><th>Gold</th><th>Reset</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Likes</strong></td>
                        <td>100/day</td>
                        <td>Unlimited</td>
                        <td>Unlimited</td>
                        <td>Midnight UTC</td>
                    </tr>
                    <tr>
                        <td><strong>Super Likes</strong></td>
                        <td>1/day</td>
                        <td>5/day</td>
                        <td>5/day</td>
                        <td>Midnight UTC</td>
                    </tr>
                    <tr>
                        <td><strong>Rewind</strong></td>
                        <td>Not available</td>
                        <td>Not available</td>
                        <td>Unlimited</td>
                        <td>N/A</td>
                    </tr>
                    <tr>
                        <td><strong>Boost</strong></td>
                        <td>Purchase only</td>
                        <td>Purchase only</td>
                        <td>1 free/week</td>
                        <td>Weekly</td>
                    </tr>
                </tbody>
            </table>
        
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
</body>
</html>