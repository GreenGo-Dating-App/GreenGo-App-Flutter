<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Tiers - GreenGo Documentation</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">ğŸŒ¿</span>
                <a href="../index.html" class="logo-text" style="text-decoration: none; color: #D4AF37;">GreenGo</a>
            </div>
        </div>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search...">
        </div>
        <ul class="nav-menu" id="navMenu">
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-home"></i><span>Overview</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="01-introduction.html">1. Introduction</a></li>
                    <li><a href="02-tech-stack.html">2. Tech Stack</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-sitemap"></i><span>Architecture</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="09-clean-architecture.html">9. Clean Architecture</a></li>
                    <li><a href="14-data-flow.html">14. Data Flow</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-palette"></i><span>Design System</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="21-brand-guidelines.html">21. Brand</a></li>
                    <li><a href="22-color-palette.html">22. Colors</a></li>
                    <li><a href="25-components.html">25. Components</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-puzzle-piece"></i><span>Core Features</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="31-auth-flow.html">31. Auth Flow</a></li>
                    <li><a href="32-social-auth.html">32. Social Auth</a></li>
                    <li><a href="33-biometric-auth.html">33. Biometric</a></li>
                    <li><a href="34-onboarding.html">34. Onboarding</a></li>
                    <li><a href="35-photo-upload.html">35. Photos</a></li>
                    <li><a href="36-profile-editing.html">36. Profile</a></li>
                    <li><a href="37-matching-algorithm.html">37. Matching</a></li>
                    <li><a href="38-discovery.html">38. Discovery</a></li>
                    <li><a href="39-like-actions.html">39. Actions</a></li>
                    <li><a href="40-match-system.html">40. Matches</a></li>
                    <li><a href="41-chat.html">41. Chat</a></li>
                    <li><a href="42-message-features.html">42. Messages</a></li>
                    <li><a href="43-push-notifications.html">43. Push</a></li>
                    <li><a href="44-in-app-notifications.html">44. Notifications</a></li>
                    <li><a href="45-subscriptions.html">45. Subscriptions</a></li>
                    <li><a href="46-in-app-purchases.html">46. Purchases</a></li>
                    <li><a href="47-coins.html">47. Coins</a></li>
                    <li><a href="48-gamification.html">48. Gamification</a></li>
                    <li><a href="49-challenges.html">49. Challenges</a></li>
                    <li><a href="50-leaderboards.html">50. Leaderboards</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-server"></i><span>Backend</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="51-firebase-overview.html">51. Firebase</a></li>
                    <li><a href="55-cloud-functions.html">55. Functions</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-database"></i><span>Database</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="61-firestore-schema.html">61. Schema</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-shield-alt"></i><span>Security</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="69-security-architecture.html">69. Security</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="top-header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            <div class="header-title"><h1>Subscription Tiers</h1></div>
        </header>

        <div class="content-wrapper">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a> / <a href="#">Core Features</a> / Subscription Tiers
                </div>
            </div>

            <div class="page-content">
                
            <h2>Subscription System Architecture</h2>
            <p>Three-tier subscription model with Stripe integration, receipt validation, and entitlement management.</p>

            <h2>Subscription Tiers</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SUBSCRIPTION TIER COMPARISON                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       BASIC         â”‚       SILVER        â”‚        GOLD         â”‚
â”‚       (Free)        â”‚     ($9.99/mo)       â”‚     ($19.99/mo)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ 100 likes/day     â”‚ âœ“ Unlimited likes   â”‚ âœ“ Unlimited likes   â”‚
â”‚ âœ“ 1 Super Like/day  â”‚ âœ“ 5 Super Likes/day â”‚ âœ“ 5 Super Likes/day â”‚
â”‚ âœ— See who likes you â”‚ âœ“ See who likes you â”‚ âœ“ See who likes you â”‚
â”‚ âœ— Rewind            â”‚ âœ— Rewind            â”‚ âœ“ Unlimited Rewind  â”‚
â”‚ âœ— Passport          â”‚ âœ— Passport          â”‚ âœ“ Passport mode     â”‚
â”‚ âœ— Advanced filters  â”‚ âœ“ Advanced filters  â”‚ âœ“ Advanced filters  â”‚
â”‚ âœ— Read receipts     â”‚ âœ— Read receipts     â”‚ âœ“ Read receipts     â”‚
â”‚ âœ— Priority likes    â”‚ âœ“ Priority likes    â”‚ âœ“ Priority likes    â”‚
â”‚ âœ— Boost             â”‚ âœ— Boost             â”‚ âœ“ 1 free boost/week â”‚
â”‚ âœ— No ads            â”‚ âœ“ No ads            â”‚ âœ“ No ads            â”‚
â”‚ Standard support    â”‚ Priority support    â”‚ VIP support         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </code></pre>

            <h2>Subscription Flow</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUBSCRIPTION PURCHASE FLOW                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client           App              Function           Stripe          Firestore
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚ Select plan   â”‚                  â”‚                 â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚ createCheckout   â”‚                 â”‚                â”‚
  â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚ Create customer â”‚                â”‚
  â”‚               â”‚                  â”‚ (if new)        â”‚                â”‚
  â”‚               â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚ Create session  â”‚                â”‚
  â”‚               â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚  sessionId       â”‚   sessionId     â”‚                â”‚
  â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚ Redirect to   â”‚                  â”‚                 â”‚                â”‚
  â”‚ Stripe        â”‚                  â”‚                 â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚ Complete      â”‚                  â”‚                 â”‚                â”‚
  â”‚ payment       â”‚                  â”‚                 â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚   Webhook       â”‚                â”‚
  â”‚               â”‚                  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚                  â”‚ Update user     â”‚                â”‚
  â”‚               â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚ Redirect      â”‚                  â”‚                 â”‚                â”‚
  â”‚ success       â”‚                  â”‚                 â”‚                â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚               â”‚ Refresh user     â”‚                 â”‚                â”‚
  â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚
  â”‚               â”‚                  â”‚                 â”‚                â”‚
  â”‚ Show premium  â”‚ Premium features â”‚                 â”‚                â”‚
  â”‚ features      â”‚ enabled          â”‚                 â”‚                â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                â”‚
            </code></pre>

            <h2>Stripe Webhook Handler</h2>
            <pre><code class="language-typescript">
// functions/src/payments/stripeWebhook.ts

export const stripeWebhook = functions.https.onRequest(async (req, res) => {
  const sig = req.headers['stripe-signature'] as string;
  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
      req.rawBody,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    console.error('Webhook signature verification failed');
    res.status(400).send('Webhook Error');
    return;
  }

  switch (event.type) {
    case 'checkout.session.completed':
      await handleCheckoutComplete(event.data.object as Stripe.Checkout.Session);
      break;

    case 'customer.subscription.created':
    case 'customer.subscription.updated':
      await handleSubscriptionUpdate(event.data.object as Stripe.Subscription);
      break;

    case 'customer.subscription.deleted':
      await handleSubscriptionCanceled(event.data.object as Stripe.Subscription);
      break;

    case 'invoice.payment_succeeded':
      await handlePaymentSucceeded(event.data.object as Stripe.Invoice);
      break;

    case 'invoice.payment_failed':
      await handlePaymentFailed(event.data.object as Stripe.Invoice);
      break;
  }

  res.json({ received: true });
});

async function handleSubscriptionUpdate(subscription: Stripe.Subscription) {
  const userId = subscription.metadata.userId;
  if (!userId) return;

  const tier = mapPriceToTier(subscription.items.data[0].price.id);

  await firestore.collection('users').doc(userId).update({
    'subscription.tier': tier,
    'subscription.status': subscription.status,
    'subscription.stripeSubscriptionId': subscription.id,
    'subscription.currentPeriodEnd': new Date(subscription.current_period_end * 1000),
    'subscription.cancelAtPeriodEnd': subscription.cancel_at_period_end,
  });

  // Update subscription document
  await firestore.collection('subscriptions').doc(subscription.id).set({
    id: subscription.id,
    oderId,
    tier,
    status: subscription.status,
    stripeCustomerId: subscription.customer as string,
    currentPeriodStart: new Date(subscription.current_period_start * 1000),
    currentPeriodEnd: new Date(subscription.current_period_end * 1000),
    cancelAtPeriodEnd: subscription.cancel_at_period_end,
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
  }, { merge: true });
}

function mapPriceToTier(priceId: string): string {
  const priceMap: Record<string, string> = {
    'price_silver_monthly': 'silver',
    'price_silver_yearly': 'silver',
    'price_gold_monthly': 'gold',
    'price_gold_yearly': 'gold',
  };
  return priceMap[priceId] || 'basic';
}
            </code></pre>

            <h2>Entitlement Checking</h2>
            <pre><code class="language-dart">
// lib/features/subscription/domain/entities/entitlements.dart

class UserEntitlements {
  final SubscriptionTier tier;
  final DateTime? expiresAt;

  bool get isActive => tier != SubscriptionTier.basic &&
      (expiresAt == null || expiresAt!.isAfter(DateTime.now()));

  bool get canSeeWhoLikesYou => tier.index >= SubscriptionTier.silver.index;
  bool get hasUnlimitedLikes => tier.index >= SubscriptionTier.silver.index;
  bool get canRewind => tier == SubscriptionTier.gold;
  bool get hasPassportMode => tier == SubscriptionTier.gold;
  bool get hasReadReceipts => tier == SubscriptionTier.gold;
  bool get hasAdvancedFilters => tier.index >= SubscriptionTier.silver.index;
  bool get hasNoAds => tier.index >= SubscriptionTier.silver.index;

  int get dailySuperLikes => switch (tier) {
    SubscriptionTier.basic => 1,
    SubscriptionTier.silver => 5,
    SubscriptionTier.gold => 5,
  };

  int get weeklyFreeBoosts => tier == SubscriptionTier.gold ? 1 : 0;
}

// Check entitlement before action
class RecordSwipeUseCase {
  Future<Either<Failure, SwipeResult>> call(SwipeParams params) async {
    final entitlements = await _getEntitlements();

    if (params.type == SwipeType.like && !entitlements.hasUnlimitedLikes) {
      final likesRemaining = await _checkDailyLikes();
      if (likesRemaining <= 0) {
        return Left(LimitReachedFailure(
          message: 'Daily like limit reached',
          upgradeRequired: true,
        ));
      }
    }

    // Proceed with swipe...
  }
}
            </code></pre>

            <h2>Subscription Data Model</h2>
            <pre><code>
// Firestore: subscriptions/{subscriptionId}

{
  "id": "sub_1234567890",
  "userId": "user_abc123",
  "tier": "gold",
  "status": "active", // active, canceled, past_due, unpaid
  "stripeSubscriptionId": "sub_1234567890",
  "stripeCustomerId": "cus_1234567890",
  "stripePriceId": "price_gold_monthly",
  "currentPeriodStart": "2024-01-01T00:00:00Z",
  "currentPeriodEnd": "2024-02-01T00:00:00Z",
  "cancelAtPeriodEnd": false,
  "canceledAt": null,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
            </code></pre>
        
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
</body>
</html>