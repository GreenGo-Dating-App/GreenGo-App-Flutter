<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Functions - System Design - GreenGo Documentation</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">ğŸŒ¿</span>
                <a href="../index.html" class="logo-text" style="text-decoration: none; color: #D4AF37;">GreenGo</a>
            </div>
        </div>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search...">
        </div>
        
        <ul class="nav-menu" id="navMenu">
            <li class="nav-section">
                <div class="nav-section-title" data-section="overview">
                    <i class="fas fa-home"></i>
                    <span>Project Overview</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="01-introduction.html">1. Project Introduction</a></li>
                    <li><a href="02-tech-stack.html">2. Technology Stack</a></li>
                    <li><a href="03-repository-structure.html">3. Repository Structure</a></li>
                    <li><a href="04-version-history.html">4. Version History</a></li>
                    <li><a href="05-getting-started.html">5. Getting Started</a></li>
                    <li><a href="06-dev-environment.html">6. Development Environment</a></li>
                    <li><a href="07-quick-start.html">7. Quick Start Tutorial</a></li>
                    <li><a href="08-glossary.html">8. Glossary & Terminology</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="architecture">
                    <i class="fas fa-sitemap"></i>
                    <span>Architecture</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="09-clean-architecture.html">9. Clean Architecture</a></li>
                    <li><a href="10-feature-modules.html">10. Feature Modules</a></li>
                    <li><a href="11-state-management.html">11. State Management (BLoC)</a></li>
                    <li><a href="12-dependency-injection.html">12. Dependency Injection</a></li>
                    <li><a href="13-repository-pattern.html">13. Repository Pattern</a></li>
                    <li><a href="14-data-flow.html">14. Data Flow Diagram</a></li>
                    <li><a href="15-error-handling.html">15. Error Handling</a></li>
                    <li><a href="16-navigation.html">16. Navigation & Routing</a></li>
                    <li><a href="17-api-layer.html">17. API & Network Layer</a></li>
                    <li><a href="18-caching.html">18. Caching Strategy</a></li>
                    <li><a href="19-real-time.html">19. Real-time Communication</a></li>
                    <li><a href="20-testing-architecture.html">20. Testing Architecture</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="design">
                    <i class="fas fa-palette"></i>
                    <span>Design System</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="21-brand-guidelines.html">21. Brand Guidelines</a></li>
                    <li><a href="22-color-palette.html">22. Color Palette</a></li>
                    <li><a href="23-typography.html">23. Typography System</a></li>
                    <li><a href="24-spacing.html">24. Spacing & Dimensions</a></li>
                    <li><a href="25-components.html">25. Component Library</a></li>
                    <li><a href="26-icons.html">26. Icon System</a></li>
                    <li><a href="27-animations.html">27. Animation Guidelines</a></li>
                    <li><a href="28-theming.html">28. Dark/Light Theme</a></li>
                    <li><a href="29-responsive.html">29. Responsive Design</a></li>
                    <li><a href="30-accessibility.html">30. Accessibility Guidelines</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="features">
                    <i class="fas fa-puzzle-piece"></i>
                    <span>Core Features</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="31-auth-flow.html">31. Authentication Flow</a></li>
                    <li><a href="32-social-auth.html">32. Social Authentication</a></li>
                    <li><a href="33-biometric-auth.html">33. Biometric Authentication</a></li>
                    <li><a href="34-onboarding.html">34. Profile Onboarding</a></li>
                    <li><a href="35-photo-upload.html">35. Photo Management</a></li>
                    <li><a href="36-profile-editing.html">36. Profile Editing</a></li>
                    <li><a href="37-matching-algorithm.html">37. Matching Algorithm</a></li>
                    <li><a href="38-discovery.html">38. Discovery Interface</a></li>
                    <li><a href="39-like-actions.html">39. Like/Pass Actions</a></li>
                    <li><a href="40-match-system.html">40. Match System</a></li>
                    <li><a href="41-chat.html">41. Real-time Chat</a></li>
                    <li><a href="42-message-features.html">42. Message Features</a></li>
                    <li><a href="43-push-notifications.html">43. Push Notifications</a></li>
                    <li><a href="44-in-app-notifications.html">44. In-App Notifications</a></li>
                    <li><a href="45-subscriptions.html">45. Subscription Tiers</a></li>
                    <li><a href="46-in-app-purchases.html">46. In-App Purchases</a></li>
                    <li><a href="47-coins.html">47. Virtual Currency</a></li>
                    <li><a href="48-gamification.html">48. Gamification System</a></li>
                    <li><a href="49-challenges.html">49. Daily Challenges</a></li>
                    <li><a href="50-leaderboards.html">50. Leaderboards</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="backend">
                    <i class="fas fa-server"></i>
                    <span>Backend Services</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="51-firebase-overview.html">51. Firebase Overview</a></li>
                    <li><a href="52-firestore.html">52. Firestore Database</a></li>
                    <li><a href="53-firebase-auth.html">53. Firebase Authentication</a></li>
                    <li><a href="54-firebase-storage.html">54. Firebase Storage</a></li>
                    <li><a href="55-cloud-functions.html">55. Cloud Functions</a></li>
                    <li><a href="56-django-backend.html">56. Django Backend</a></li>
                    <li><a href="57-api-documentation.html">57. API Documentation</a></li>
                    <li><a href="58-realtime-sync.html">58. Real-time Sync</a></li>
                    <li><a href="59-background-processing.html">59. Background Processing</a></li>
                    <li><a href="60-rate-limiting.html">60. Rate Limiting</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="database">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="61-firestore-schema.html">61. Firestore Schema</a></li>
                    <li><a href="62-postgresql-schema.html">62. PostgreSQL Schema</a></li>
                    <li><a href="63-data-migration.html">63. Data Migration</a></li>
                    <li><a href="64-indexing.html">64. Indexing Strategy</a></li>
                    <li><a href="65-backup-recovery.html">65. Backup & Recovery</a></li>
                    <li><a href="66-data-retention.html">66. Data Retention Policy</a></li>
                    <li><a href="67-redis-caching.html">67. Redis Caching</a></li>
                    <li><a href="68-bigquery.html">68. BigQuery Analytics</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="security">
                    <i class="fas fa-shield-alt"></i>
                    <span>Security</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="69-security-architecture.html">69. Security Architecture</a></li>
                    <li><a href="70-firestore-rules.html">70. Firestore Rules</a></li>
                    <li><a href="71-storage-rules.html">71. Storage Rules</a></li>
                    <li><a href="72-auth-security.html">72. Authentication Security</a></li>
                    <li><a href="73-encryption.html">73. Data Encryption</a></li>
                    <li><a href="74-app-check.html">74. App Check</a></li>
                    <li><a href="75-content-moderation.html">75. Content Moderation</a></li>
                    <li><a href="76-spam-detection.html">76. Spam Detection</a></li>
                    <li><a href="77-reporting-system.html">77. Reporting System</a></li>
                    <li><a href="78-security-audit.html">78. Security Audit</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="integrations">
                    <i class="fas fa-plug"></i>
                    <span>Integrations</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="79-agora-video.html">79. Agora Video Calling</a></li>
                    <li><a href="80-stripe.html">80. Stripe Payments</a></li>
                    <li><a href="81-sendgrid.html">81. SendGrid Email</a></li>
                    <li><a href="82-twilio.html">82. Twilio SMS</a></li>
                    <li><a href="83-google-maps.html">83. Google Maps</a></li>
                    <li><a href="84-google-cloud-ai.html">84. Google Cloud AI</a></li>
                    <li><a href="85-mixpanel.html">85. Mixpanel Analytics</a></li>
                    <li><a href="86-sentry.html">86. Sentry Tracking</a></li>
                    <li><a href="87-perspective-api.html">87. Perspective API</a></li>
                    <li><a href="88-revenuecat.html">88. RevenueCat</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="devops">
                    <i class="fas fa-cogs"></i>
                    <span>DevOps</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="89-terraform.html">89. Terraform Infrastructure</a></li>
                    <li><a href="90-docker.html">90. Docker Development</a></li>
                    <li><a href="91-cicd.html">91. CI/CD Pipeline</a></li>
                    <li><a href="92-environments.html">92. Environment Management</a></li>
                    <li><a href="93-feature-flags.html">93. Feature Flags</a></li>
                    <li><a href="94-pre-commit.html">94. Pre-commit Hooks</a></li>
                    <li><a href="95-deployment.html">95. Deployment Scripts</a></li>
                    <li><a href="96-firebase-hosting.html">96. Firebase Hosting</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title" data-section="testing">
                    <i class="fas fa-vial"></i>
                    <span>Testing</span>
                    <i class="fas fa-chevron-down arrow"></i>
                </div>
                <ul class="nav-submenu">
                    <li><a href="97-unit-testing.html">97. Unit Testing</a></li>
                    <li><a href="98-widget-testing.html">98. Widget Testing</a></li>
                    <li><a href="99-integration-testing.html">99. Integration Testing</a></li>
                    <li><a href="100-firebase-test-lab.html">100. Firebase Test Lab</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="top-header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            <div class="header-title"><h1>Cloud Functions - System Design</h1></div>
        </header>

        <div class="content-wrapper">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a> / <a href="#">Backend Services</a> / Cloud Functions - System Design
                </div>
            </div>

            <div class="page-content">
                
            <h2>Cloud Functions Architecture</h2>
            <p>GreenGo uses 70+ Cloud Functions organized by domain, handling everything from user management to ML-powered matching.</p>

            <h2>Functions Organization</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUD FUNCTIONS ARCHITECTURE                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # Main exports
â”‚   â”œâ”€â”€ auth/                       # Authentication functions
â”‚   â”‚   â”œâ”€â”€ onUserCreate.ts         # New user setup
â”‚   â”‚   â”œâ”€â”€ onUserDelete.ts         # Cleanup on delete
â”‚   â”‚   â””â”€â”€ customToken.ts          # Custom auth tokens
â”‚   â”‚
â”‚   â”œâ”€â”€ users/                      # User management
â”‚   â”‚   â”œâ”€â”€ updateProfile.ts        # Profile updates
â”‚   â”‚   â”œâ”€â”€ uploadPhoto.ts          # Photo processing
â”‚   â”‚   â”œâ”€â”€ updateLocation.ts       # Geolocation
â”‚   â”‚   â””â”€â”€ deleteAccount.ts        # GDPR deletion
â”‚   â”‚
â”‚   â”œâ”€â”€ matching/                   # Matching system
â”‚   â”‚   â”œâ”€â”€ getPotentialMatches.ts  # ML recommendations
â”‚   â”‚   â”œâ”€â”€ recordSwipe.ts          # Like/Pass actions
â”‚   â”‚   â”œâ”€â”€ onMatchCreate.ts        # Match triggers
â”‚   â”‚   â””â”€â”€ calculateScore.ts       # Compatibility
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                       # Messaging
â”‚   â”‚   â”œâ”€â”€ onMessageCreate.ts      # Message triggers
â”‚   â”‚   â”œâ”€â”€ sendMessage.ts          # Send with validation
â”‚   â”‚   â””â”€â”€ markAsRead.ts           # Read receipts
â”‚   â”‚
â”‚   â”œâ”€â”€ notifications/              # Push notifications
â”‚   â”‚   â”œâ”€â”€ sendPush.ts             # FCM sending
â”‚   â”‚   â”œâ”€â”€ onNotificationCreate.ts # Notification triggers
â”‚   â”‚   â””â”€â”€ scheduleReminder.ts     # Scheduled notifs
â”‚   â”‚
â”‚   â”œâ”€â”€ payments/                   # Monetization
â”‚   â”‚   â”œâ”€â”€ processPayment.ts       # Stripe integration
â”‚   â”‚   â”œâ”€â”€ webhookHandler.ts       # Stripe webhooks
â”‚   â”‚   â”œâ”€â”€ createSubscription.ts   # Subscription mgmt
â”‚   â”‚   â””â”€â”€ purchaseCoins.ts        # In-app purchases
â”‚   â”‚
â”‚   â”œâ”€â”€ moderation/                 # Content safety
â”‚   â”‚   â”œâ”€â”€ moderatePhoto.ts        # Image moderation
â”‚   â”‚   â”œâ”€â”€ moderateText.ts         # Text moderation
â”‚   â”‚   â”œâ”€â”€ handleReport.ts         # User reports
â”‚   â”‚   â””â”€â”€ autoban.ts              # Automatic bans
â”‚   â”‚
â”‚   â”œâ”€â”€ gamification/               # Game mechanics
â”‚   â”‚   â”œâ”€â”€ awardXP.ts              # XP system
â”‚   â”‚   â”œâ”€â”€ checkAchievements.ts    # Achievement unlock
â”‚   â”‚   â”œâ”€â”€ dailyChallenge.ts       # Daily tasks
â”‚   â”‚   â””â”€â”€ updateLeaderboard.ts    # Rankings
â”‚   â”‚
â”‚   â””â”€â”€ scheduled/                  # Cron jobs
â”‚       â”œâ”€â”€ dailyDigest.ts          # Daily emails
â”‚       â”œâ”€â”€ cleanupExpired.ts       # Data cleanup
â”‚       â”œâ”€â”€ updateStats.ts          # Analytics
â”‚       â””â”€â”€ refreshML.ts            # ML model refresh
â”‚
â”œâ”€â”€ lib/                            # Shared utilities
â”‚   â”œâ”€â”€ firebase.ts                 # Firebase admin
â”‚   â”œâ”€â”€ stripe.ts                   # Stripe client
â”‚   â”œâ”€â”€ sendgrid.ts                 # Email client
â”‚   â””â”€â”€ ml.ts                       # ML utilities
â”‚
â””â”€â”€ package.json
            </code></pre>

            <h2>Function Types & Triggers</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FUNCTION TRIGGER TYPES                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE TRIGGERS â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  onCreate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onUserCreate, onSwipeCreate, onMessageCreate
â”‚  onUpdate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onProfileUpdate, onSubscriptionUpdate
â”‚  onDelete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onUserDelete, onMatchDelete
â”‚  onWrite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onSettingsChange
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STORAGE TRIGGERS   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  onFinalize â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onPhotoUpload (resize, moderate)
â”‚  onDelete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onPhotoDelete (cleanup refs)
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AUTH TRIGGERS      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  onCreate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onUserCreate (welcome email, init profile)
â”‚  onDelete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ onUserDelete (cleanup all data)
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTPS CALLABLE     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  Authenticated â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ getPotentialMatches, recordSwipe, sendMessage
â”‚                     â”‚    processPayment, updateProfile, reportUser
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCHEDULED (CRON)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  Every minute â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ processNotificationQueue
â”‚  Every hour â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ updateLeaderboards, cleanupExpiredBoosts
â”‚  Daily at 8am â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ sendDailyDigest, generateDailyChallenges
â”‚  Weekly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ generateWeeklyReport, refreshMLModels
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PUB/SUB            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  ml-predictions â”€â”€â”€â”€â”¼â”€â”€â–¶ processMLPrediction
â”‚  analytics-events â”€â”€â”¼â”€â”€â–¶ processAnalyticsEvent
â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </code></pre>

            <h2>Matching Algorithm Function</h2>
            <p><strong>File:</strong> <code>functions/src/matching/getPotentialMatches.ts</code></p>
            <pre><code class="language-typescript">
import * as functions from 'firebase-functions';
import { firestore } from '../lib/firebase';
import { calculateCompatibility } from '../lib/ml';

interface MatchFilters {
  minAge: number;
  maxAge: number;
  maxDistance: number;
  genderPreference: string[];
}

export const getPotentialMatches = functions
  .runWith({
    memory: '1GB',
    timeoutSeconds: 60,
    minInstances: 1, // Keep warm
  })
  .https.onCall(async (data, context) => {
    // Verify authentication
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'Must be logged in'
      );
    }

    const userId = context.auth.uid;
    const { limit = 50, filters } = data as {
      limit: number;
      filters: MatchFilters;
    };

    // Get current user
    const userDoc = await firestore.collection('users').doc(userId).get();
    const user = userDoc.data();

    if (!user) {
      throw new functions.https.HttpsError('not-found', 'User not found');
    }

    // Get already swiped users
    const swipedSnapshot = await firestore
      .collection('swipes')
      .where('swiperId', '==', userId)
      .select('swipedId')
      .get();

    const swipedIds = new Set(swipedSnapshot.docs.map(d => d.data().swipedId));
    swipedIds.add(userId); // Exclude self

    // Build query for potential matches
    let query = firestore
      .collection('users')
      .where('isActive', '==', true)
      .where('isOnboardingComplete', '==', true);

    // Apply gender filter
    if (filters.genderPreference.length > 0) {
      query = query.where('gender', 'in', filters.genderPreference);
    }

    // Apply age filter
    const now = new Date();
    const minBirthDate = new Date(
      now.getFullYear() - filters.maxAge,
      now.getMonth(),
      now.getDate()
    );
    const maxBirthDate = new Date(
      now.getFullYear() - filters.minAge,
      now.getMonth(),
      now.getDate()
    );

    query = query
      .where('birthDate', '>=', minBirthDate)
      .where('birthDate', '<=', maxBirthDate);

    // Get candidates
    const candidatesSnapshot = await query.limit(limit * 3).get();

    // Filter and score candidates
    const candidates = [];

    for (const doc of candidatesSnapshot.docs) {
      if (swipedIds.has(doc.id)) continue;

      const candidate = doc.data();

      // Check distance
      const distance = calculateDistance(
        user.location,
        candidate.location
      );

      if (distance > filters.maxDistance) continue;

      // Calculate ML compatibility score
      const compatibilityScore = await calculateCompatibility(
        user.mlVector,
        candidate.mlVector
      );

      candidates.push({
        id: doc.id,
        ...candidate,
        distance,
        compatibilityScore,
      });
    }

    // Sort by compatibility score
    candidates.sort((a, b) => b.compatibilityScore - a.compatibilityScore);

    // Return top matches
    return {
      matches: candidates.slice(0, limit),
      hasMore: candidates.length > limit,
    };
  });

function calculateDistance(
  loc1: { latitude: number; longitude: number },
  loc2: { latitude: number; longitude: number }
): number {
  const R = 6371; // Earth's radius in km
  const dLat = toRad(loc2.latitude - loc1.latitude);
  const dLon = toRad(loc2.longitude - loc1.longitude);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(loc1.latitude)) *
      Math.cos(toRad(loc2.latitude)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function toRad(deg: number): number {
  return deg * (Math.PI / 180);
}
            </code></pre>

            <h2>Function Execution Flow</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SWIPE TO MATCH EXECUTION FLOW                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                recordSwipe           onSwipeCreate         onMatchCreate
  â”‚                       â”‚                      â”‚                      â”‚
  â”‚ swipe(targetId,LIKE)  â”‚                      â”‚                      â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚                      â”‚
  â”‚                       â”‚                      â”‚                      â”‚
  â”‚                       â”‚ Validate auth        â”‚                      â”‚
  â”‚                       â”‚ Check rate limit     â”‚                      â”‚
  â”‚                       â”‚ Check subscription   â”‚                      â”‚
  â”‚                       â”‚         â”‚            â”‚                      â”‚
  â”‚                       â”‚         â–¼            â”‚                      â”‚
  â”‚                       â”‚ Write to swipes/     â”‚                      â”‚
  â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
  â”‚                       â”‚                      â”‚                      â”‚
  â”‚                       â”‚                      â”‚ Query reverse swipe  â”‚
  â”‚                       â”‚                      â”‚         â”‚            â”‚
  â”‚                       â”‚                      â”‚         â–¼            â”‚
  â”‚                       â”‚                      â”‚ swiperId=target      â”‚
  â”‚                       â”‚                      â”‚ swipedId=user        â”‚
  â”‚                       â”‚                      â”‚ type=LIKE            â”‚
  â”‚                       â”‚                      â”‚         â”‚            â”‚
  â”‚                       â”‚                      â”‚    MATCH FOUND!      â”‚
  â”‚                       â”‚                      â”‚         â”‚            â”‚
  â”‚                       â”‚                      â”‚         â–¼            â”‚
  â”‚                       â”‚                      â”‚ Create match doc     â”‚
  â”‚                       â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                       â”‚                      â”‚                      â”‚
  â”‚                       â”‚                      â”‚                      â”‚ Create conversation
  â”‚                       â”‚                      â”‚                      â”‚ Send FCM to both
  â”‚                       â”‚                      â”‚                      â”‚ Award XP to both
  â”‚                       â”‚                      â”‚                      â”‚ Update stats
  â”‚                       â”‚                      â”‚                      â”‚
  â”‚                       â”‚ return {matched:true}â”‚                      â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                      â”‚                      â”‚
            </code></pre>

            <h2>Function Configuration</h2>
            <table>
                <thead>
                    <tr><th>Function</th><th>Memory</th><th>Timeout</th><th>Min Instances</th><th>Max Instances</th></tr>
                </thead>
                <tbody>
                    <tr><td>getPotentialMatches</td><td>1GB</td><td>60s</td><td>1</td><td>100</td></tr>
                    <tr><td>recordSwipe</td><td>256MB</td><td>30s</td><td>1</td><td>500</td></tr>
                    <tr><td>processPayment</td><td>512MB</td><td>60s</td><td>1</td><td>50</td></tr>
                    <tr><td>moderatePhoto</td><td>2GB</td><td>120s</td><td>0</td><td>20</td></tr>
                    <tr><td>sendPush</td><td>256MB</td><td>30s</td><td>1</td><td>200</td></tr>
                    <tr><td>onMessageCreate</td><td>256MB</td><td>30s</td><td>1</td><td>500</td></tr>
                </tbody>
            </table>
        
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
</body>
</html>