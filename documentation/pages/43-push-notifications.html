<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notifications - GreenGo Documentation</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">ğŸŒ¿</span>
                <a href="../index.html" class="logo-text" style="text-decoration: none; color: #D4AF37;">GreenGo</a>
            </div>
        </div>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search...">
        </div>
        <ul class="nav-menu" id="navMenu">
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-home"></i><span>Overview</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="01-introduction.html">1. Introduction</a></li>
                    <li><a href="02-tech-stack.html">2. Tech Stack</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-sitemap"></i><span>Architecture</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="09-clean-architecture.html">9. Clean Architecture</a></li>
                    <li><a href="14-data-flow.html">14. Data Flow</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-palette"></i><span>Design System</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="21-brand-guidelines.html">21. Brand</a></li>
                    <li><a href="22-color-palette.html">22. Colors</a></li>
                    <li><a href="25-components.html">25. Components</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-puzzle-piece"></i><span>Core Features</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="31-auth-flow.html">31. Auth Flow</a></li>
                    <li><a href="32-social-auth.html">32. Social Auth</a></li>
                    <li><a href="33-biometric-auth.html">33. Biometric</a></li>
                    <li><a href="34-onboarding.html">34. Onboarding</a></li>
                    <li><a href="35-photo-upload.html">35. Photos</a></li>
                    <li><a href="36-profile-editing.html">36. Profile</a></li>
                    <li><a href="37-matching-algorithm.html">37. Matching</a></li>
                    <li><a href="38-discovery.html">38. Discovery</a></li>
                    <li><a href="39-like-actions.html">39. Actions</a></li>
                    <li><a href="40-match-system.html">40. Matches</a></li>
                    <li><a href="41-chat.html">41. Chat</a></li>
                    <li><a href="42-message-features.html">42. Messages</a></li>
                    <li><a href="43-push-notifications.html">43. Push</a></li>
                    <li><a href="44-in-app-notifications.html">44. Notifications</a></li>
                    <li><a href="45-subscriptions.html">45. Subscriptions</a></li>
                    <li><a href="46-in-app-purchases.html">46. Purchases</a></li>
                    <li><a href="47-coins.html">47. Coins</a></li>
                    <li><a href="48-gamification.html">48. Gamification</a></li>
                    <li><a href="49-challenges.html">49. Challenges</a></li>
                    <li><a href="50-leaderboards.html">50. Leaderboards</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-server"></i><span>Backend</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="51-firebase-overview.html">51. Firebase</a></li>
                    <li><a href="55-cloud-functions.html">55. Functions</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-database"></i><span>Database</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="61-firestore-schema.html">61. Schema</a></li>
                </ul>
            </li>
            <li class="nav-section">
                <div class="nav-section-title"><i class="fas fa-shield-alt"></i><span>Security</span><i class="fas fa-chevron-down arrow"></i></div>
                <ul class="nav-submenu">
                    <li><a href="69-security-architecture.html">69. Security</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="top-header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            <div class="header-title"><h1>Push Notifications</h1></div>
        </header>

        <div class="content-wrapper">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a> / <a href="#">Core Features</a> / Push Notifications
                </div>
            </div>

            <div class="page-content">
                
            <h2>Push Notification System</h2>
            <p>Firebase Cloud Messaging integration for real-time push notifications across iOS, Android, and Web.</p>

            <h2>Notification Architecture</h2>
            <pre><code>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PUSH NOTIFICATION ARCHITECTURE                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   TRIGGER       â”‚
                              â”‚   EVENT         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                        â”‚                        â”‚
              â–¼                        â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   NEW MATCH     â”‚      â”‚   NEW MESSAGE   â”‚      â”‚   SUPER LIKE    â”‚
    â”‚   onMatchCreate â”‚      â”‚  onMessageCreateâ”‚      â”‚  onSwipeCreate  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚                        â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  NOTIFICATION       â”‚
                           â”‚  SERVICE            â”‚
                           â”‚  â€¢ Build payload    â”‚
                           â”‚  â€¢ Check prefs      â”‚
                           â”‚  â€¢ Get FCM tokens   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  FIREBASE CLOUD     â”‚
                           â”‚  MESSAGING          â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                       â”‚                       â”‚
              â–¼                       â–¼                       â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    iOS    â”‚           â”‚  Android  â”‚           â”‚    Web    â”‚
       â”‚   APNs    â”‚           â”‚   FCM     â”‚           â”‚   FCM     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </code></pre>

            <h2>Notification Types</h2>
            <table>
                <thead>
                    <tr><th>Type</th><th>Trigger</th><th>Priority</th><th>Sound</th><th>Action</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>New Match</strong></td>
                        <td>Match created</td>
                        <td>High</td>
                        <td>match.wav</td>
                        <td>Open matches</td>
                    </tr>
                    <tr>
                        <td><strong>New Message</strong></td>
                        <td>Message received</td>
                        <td>High</td>
                        <td>message.wav</td>
                        <td>Open chat</td>
                    </tr>
                    <tr>
                        <td><strong>Super Like</strong></td>
                        <td>Super like received</td>
                        <td>High</td>
                        <td>superlike.wav</td>
                        <td>Open discovery</td>
                    </tr>
                    <tr>
                        <td><strong>Profile View</strong></td>
                        <td>Profile viewed (Gold)</td>
                        <td>Normal</td>
                        <td>Default</td>
                        <td>Open likes</td>
                    </tr>
                    <tr>
                        <td><strong>Daily Reminder</strong></td>
                        <td>Scheduled</td>
                        <td>Normal</td>
                        <td>Default</td>
                        <td>Open app</td>
                    </tr>
                </tbody>
            </table>

            <h2>FCM Token Management</h2>
            <pre><code class="language-dart">
// lib/core/services/notification_service.dart

class NotificationService {
  final FirebaseMessaging _fcm;
  final FirebaseFirestore _firestore;
  final FlutterLocalNotificationsPlugin _local;

  Future<void> initialize() async {
    // Request permission
    final settings = await _fcm.requestPermission(
      alert: true,
      badge: true,
      sound: true,
      provisional: false,
    );

    if (settings.authorizationStatus == AuthorizationStatus.authorized) {
      // Get FCM token
      final token = await _fcm.getToken();
      if (token != null) {
        await _saveToken(token);
      }

      // Listen for token refresh
      _fcm.onTokenRefresh.listen(_saveToken);
    }

    // Configure message handlers
    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);
    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);
    FirebaseMessaging.onBackgroundMessage(_handleBackgroundMessage);

    // Configure local notifications
    await _configureLocalNotifications();
  }

  Future<void> _saveToken(String token) async {
    final userId = FirebaseAuth.instance.currentUser?.uid;
    if (userId == null) return;

    await _firestore.collection('users').doc(userId).update({
      'fcmTokens': FieldValue.arrayUnion([token]),
      'lastTokenUpdate': FieldValue.serverTimestamp(),
    });
  }

  Future<void> _configureLocalNotifications() async {
    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');
    const iosSettings = DarwinInitializationSettings(
      requestAlertPermission: false,
      requestBadgePermission: false,
      requestSoundPermission: false,
    );

    await _local.initialize(
      InitializationSettings(android: androidSettings, iOS: iosSettings),
      onDidReceiveNotificationResponse: _onNotificationResponse,
    );

    // Create notification channels (Android)
    await _createNotificationChannels();
  }

  Future<void> _createNotificationChannels() async {
    final android = _local.resolvePlatformSpecificImplementation<
        AndroidFlutterLocalNotificationsPlugin>();

    await android?.createNotificationChannel(AndroidNotificationChannel(
      'matches',
      'Matches',
      description: 'New match notifications',
      importance: Importance.high,
      sound: RawResourceAndroidNotificationSound('match'),
    ));

    await android?.createNotificationChannel(AndroidNotificationChannel(
      'messages',
      'Messages',
      description: 'New message notifications',
      importance: Importance.high,
      sound: RawResourceAndroidNotificationSound('message'),
    ));
  }

  void _handleForegroundMessage(RemoteMessage message) {
    // Show local notification when app is in foreground
    final notification = message.notification;
    if (notification == null) return;

    _local.show(
      message.hashCode,
      notification.title,
      notification.body,
      NotificationDetails(
        android: AndroidNotificationDetails(
          message.data['channel'] ?? 'default',
          message.data['channelName'] ?? 'Default',
          icon: '@mipmap/ic_notification',
        ),
        iOS: DarwinNotificationDetails(
          presentAlert: true,
          presentBadge: true,
          presentSound: true,
        ),
      ),
      payload: jsonEncode(message.data),
    );
  }
}
            </code></pre>

            <h2>Cloud Function - Send Notification</h2>
            <pre><code class="language-typescript">
// functions/src/notifications/sendNotification.ts

interface NotificationPayload {
  userId: string;
  type: NotificationType;
  title: string;
  body: string;
  data?: Record<string, string>;
  imageUrl?: string;
}

export async function sendPushNotification(payload: NotificationPayload): Promise<void> {
  const { userId, type, title, body, data, imageUrl } = payload;

  // Check user notification preferences
  const userDoc = await firestore.collection('users').doc(userId).get();
  const user = userDoc.data();

  if (!user?.settings?.pushEnabled) {
    return;
  }

  // Check specific notification type preference
  if (!isNotificationTypeEnabled(user.settings, type)) {
    return;
  }

  // Get FCM tokens
  const tokens = user.fcmTokens || [];
  if (tokens.length === 0) {
    return;
  }

  // Build FCM message
  const message: admin.messaging.MulticastMessage = {
    tokens,
    notification: {
      title,
      body,
      imageUrl,
    },
    data: {
      type,
      click_action: 'FLUTTER_NOTIFICATION_CLICK',
      ...data,
    },
    android: {
      priority: 'high',
      notification: {
        channelId: getChannelForType(type),
        sound: getSoundForType(type),
        icon: '@mipmap/ic_notification',
        color: '#D4AF37',
      },
    },
    apns: {
      payload: {
        aps: {
          sound: getSoundForType(type) + '.wav',
          badge: 1,
          'mutable-content': 1,
        },
      },
    },
  };

  // Send notification
  const response = await admin.messaging().sendEachForMulticast(message);

  // Handle failed tokens
  if (response.failureCount > 0) {
    const failedTokens: string[] = [];
    response.responses.forEach((resp, idx) => {
      if (!resp.success) {
        failedTokens.push(tokens[idx]);
      }
    });

    // Remove invalid tokens
    await firestore.collection('users').doc(userId).update({
      fcmTokens: admin.firestore.FieldValue.arrayRemove(...failedTokens),
    });
  }

  // Store notification in database
  await firestore.collection('users').doc(userId).collection('notifications').add({
    type,
    title,
    body,
    data,
    read: false,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
  });
}

function getChannelForType(type: NotificationType): string {
  switch (type) {
    case 'match': return 'matches';
    case 'message': return 'messages';
    case 'superlike': return 'matches';
    default: return 'default';
  }
}
            </code></pre>
        
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
</body>
</html>