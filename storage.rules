rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    // Check if file is a video
    function isVideo() {
      return request.resource.contentType.matches('video/.*');
    }

    // Check if file is audio
    function isAudio() {
      return request.resource.contentType.matches('audio/.*');
    }

    // Check file size (in bytes)
    function isValidSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }

    // Validate image file
    function isValidImage() {
      return isImage() && isValidSize(10);  // Max 10MB
    }

    // Validate video file
    function isValidVideo() {
      return isVideo() && isValidSize(100);  // Max 100MB
    }

    // Validate audio file
    function isValidAudio() {
      return isAudio() && isValidSize(10);  // Max 10MB
    }

    // ============================================================================
    // USER PHOTOS BUCKET
    // Pattern: /user_photos/{userId}/{photoId}
    // ============================================================================
    match /user_photos/{userId}/{photoId} {
      // Anyone authenticated can read photos
      allow read: if isSignedIn();

      // Only the user can upload their photos
      allow write: if isOwner(userId) &&
                      isValidImage();

      // Only the user can delete their photos
      allow delete: if isOwner(userId);
    }

    // ============================================================================
    // PROFILE MEDIA BUCKET
    // Pattern: /profile_media/{userId}/{type}/{fileName}
    // Types: photos, videos, voice
    // ============================================================================
    match /profile_media/{userId}/photos/{fileName} {
      allow read: if isSignedIn();

      allow write: if isOwner(userId) &&
                      isValidImage();

      allow delete: if isOwner(userId);
    }

    match /profile_media/{userId}/videos/{fileName} {
      allow read: if isSignedIn();

      allow write: if isOwner(userId) &&
                      isValidVideo();

      allow delete: if isOwner(userId);
    }

    match /profile_media/{userId}/voice/{fileName} {
      allow read: if isSignedIn();

      allow write: if isOwner(userId) &&
                      isValidAudio();

      allow delete: if isOwner(userId);
    }

    // ============================================================================
    // CHAT ATTACHMENTS BUCKET
    // Pattern: /chat_attachments/{conversationId}/{senderId}/{fileName}
    // ============================================================================
    match /chat_attachments/{conversationId}/{senderId}/{fileName} {
      // Users in the conversation can read attachments
      allow read: if isSignedIn() &&
                     request.auth.uid in firestore.get(/databases/(default)/documents/conversations/$(conversationId)).data.participants;

      // Users can upload attachments to their conversations
      allow write: if isSignedIn() &&
                      isOwner(senderId) &&
                      request.auth.uid in firestore.get(/databases/(default)/documents/conversations/$(conversationId)).data.participants &&
                      (isValidImage() || isValidVideo() || isValidAudio());

      // Only the sender can delete their attachments
      allow delete: if isOwner(senderId);
    }

    // ============================================================================
    // VERIFIED PHOTOS BUCKET (AI-verified photos)
    // Pattern: /verified_photos/{userId}/{photoId}
    // ============================================================================
    match /verified_photos/{userId}/{photoId} {
      allow read: if isSignedIn();

      // Only backend (Cloud Functions) can write verified photos
      allow write: if false;

      // Only the user can delete verified photos
      allow delete: if isOwner(userId);
    }

    // ============================================================================
    // THUMBNAILS BUCKET (Auto-generated thumbnails)
    // Pattern: /thumbnails/{userId}/{size}/{photoId}
    // Sizes: small (100x100), medium (300x300), large (800x800)
    // ============================================================================
    match /thumbnails/{userId}/{size}/{photoId} {
      allow read: if isSignedIn();

      // Only backend can write thumbnails
      allow write: if false;

      // Thumbnails are managed by backend
      allow delete: if false;
    }

    // ============================================================================
    // BACKUPS BUCKET (Read-only for users)
    // Pattern: /backups/{userId}/{timestamp}/{fileName}
    // ============================================================================
    match /backups/{userId}/{timestamp}/{fileName} {
      // Users can read their own backups
      allow read: if isOwner(userId);

      // Only backend can create backups
      allow write: if false;

      // Backups cannot be deleted manually
      allow delete: if false;
    }

    // ============================================================================
    // TEMPORARY UPLOADS (For processing)
    // Pattern: /temp/{userId}/{uploadId}
    // These files are automatically deleted after 24 hours
    // ============================================================================
    match /temp/{userId}/{uploadId} {
      // Only the user can read their temp files
      allow read: if isOwner(userId);

      // Users can upload temp files
      allow write: if isOwner(userId) &&
                      isValidSize(50);  // Max 50MB

      // Users can delete their temp files
      allow delete: if isOwner(userId);
    }

    // ============================================================================
    // MODERATION BUCKET (Flagged content)
    // Pattern: /moderation/{reportId}/{fileName}
    // ============================================================================
    match /moderation/{reportId}/{fileName} {
      // Only admins can read flagged content
      allow read: if false;  // Handled by backend/admin

      // Only backend can write to moderation bucket
      allow write: if false;

      // Only backend can delete flagged content
      allow delete: if false;
    }

    // ============================================================================
    // PUBLIC ASSETS (App resources)
    // Pattern: /public/{assetType}/{fileName}
    // ============================================================================
    match /public/{assetType}/{fileName} {
      // Anyone can read public assets
      allow read: if true;

      // Only backend can upload public assets
      allow write: if false;
      allow delete: if false;
    }

    // ============================================================================
    // DEFAULT DENY ALL
    // ============================================================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
